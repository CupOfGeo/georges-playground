name: Flyway Migration
# thanks to https://haha.world/recipe-gh-action-cloud-sql/
on:
  push:
    branches:
      - main


jobs:
  migration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: gcloud install dependencies
        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
        with:
          project_id: ${{ env.gcp-project-name }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Get Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
      - name: Backup staging database
        run: |
          gcloud sql backups create --instance=${{env.gcp-cloud-sql-instance}}
      - name: Run migration
        env:
          TYPEORM_CONNECTION: postgres
          TYPEORM_HOST: 127.0.0.1
          TYPEORM_PORT: 5432
          TYPEORM_USERNAME: user
          TYPEORM_DATABASE: database_name
          TYPEORM_PASSWORD: ${{ secrets.CLOUD_SQL_PASSWORD }}
          TYPEORM_MIGRATIONS: ./migration/**/*.ts
        run: |
          ./cloud_sql_proxy -instances=nice-cb-dev:us-central1:nice-db-dev=tcp:5432 &
          npm run orm:migration:run:staging


      - name: Set up JDK 1.8
        uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'adopt'

      - name: Cache Flyway
        uses: actions/cache@v2
        with:
          path: ~/flyway
          key: ${{ runner.os }}-flyway-${{ hashFiles('**/flyway*.conf') }}

      - name: Download Flyway
        run: |
          mkdir -p ~/flyway
          curl -L https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/7.15.0/flyway-commandline-7.15.0-linux-x64.tar.gz -o ~/flyway/flyway-commandline.tar.gz
          tar -xzf ~/flyway/flyway-commandline.tar.gz --strip-components=1 -C ~/flyway

      - name: Run Flyway Migrate
        run: ~/flyway/flyway -user="crud_fastapi_app" -password="${{ secrets.DB_PASSWORD }}" -url="jdbc:postgresql:///${{ secrets.DB_HOST }}:5432/crud_fastapi_app" -locations="filesystem:/crud-fastapi/migrationsl" migrate
